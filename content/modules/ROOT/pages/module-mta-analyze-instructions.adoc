= Assessment and Analysis - Instructions
:imagesdir: ../assets/images/

== 1. Goals of this lab

As part of the digital transformation and cloud adoption initiative of a large organization, the development and devops teams embarked upon a journey to modernize their existing siloed services running on virtual machines.

The goal of this lab is to assess and analyze the current application portfolio and identify potential issues and risks to implementing advanced cloud-native architectures with application modernization.

== 2. Introduction to Migration Toolkit for Applications

To work on the migration of the existing applications in our portfolio we will use the https://developers.redhat.com/products/mta/overview[Migration Toolkit for Applications (MTA)^]. _MTA_ will be used to assess, analyze and finally migrate the `Customers` application, currently running on a _Tomcat_ server on a VM.

Open a new browser to access the {mta_url}[MTA Web Console^].

NOTE: For this lab the MTA Web Console is readily available at that URL. In a production-ready environment the console would be secured by Red Hat Single Sign On and require you to log in with valid credentials.

You will see existing application in the inventory such as *Customers*, *Orders*, *Inventory*, and more.

image::mta-analyze/mta-application-inventory.png[application inventory]

The user experience in MTA 7 revolves around the **Application Inventory**, allowing organizations to have a holistic view of their application portfolio.

The inventory also offers seamless integration with other tools, like the https://access.redhat.com/documentation/en-us/migration_toolkit_for_applications/7.0/html/user_interface_guide/assessing-and-analyzing-applications#mta-assessment-changes-700_user-interface-guide[Assessment^] and https://access.redhat.com/documentation/en-us/migration_toolkit_for_applications/7.0/html/user_interface_guide/assessing-and-analyzing-applications#analyzing-an-application_user-interface-guide[Analysis^] modules, to surface information about the portfolio at scale.

== 2.1. Application Profile

As the portfolio goes through the different processes available in the tool, surfaced information will be stored individually in each application profile. That includes metrics such as risk level and effort required to migrate, and precise data about issues that need to be solved and the application's technology stack.

Click on the _Customers_ application. You will see a side drawer with the application profile opens:

image::mta-analyze/mta-inventory-profile.png[inventory]

One of the key challenges when dealing with large portfolios is being able to figure out a way to group applications together and then come up with different migration strategies for each of those groups. A powerful feature that helps with application classification is an extensible tagging model that allows to classify applications in multiple dimensions. MTA comes out of the box with a wide set of curated categories and tags, but users can add as many as they want to model any concept that could be meaningful in the context of their organization and the application landscape.

Click on the _Tags_ tab from the _Application Profile_ and you will see a list of tags associated to the _Customers_ application.

image::mta-analyze/mta-inventory-profile-tags.png[inventory]

Since the _Customers_ application is a Spring application running on top of a Tomcat server, we have added tags that represent the application technology stack, like _Java_, _Tomcat_ and some _Spring_ components. There's also an additional custom tag representing the usage of a custom corporate configuration library. This should be something to be taken into account, as configuration is one of the key concerns when onboarding an application into the Cloud.

== 2.2. Archetypes

When dealing with applications at scale, a more sophisticated way of grouping applications together might be required to manage large portfolios effectively. **Archetypes** allow exactly that by automatically classifying applications based on their tag taxonomy. At the same time, applications associated with an archetype inherit some of their features such as additional tags or assessment data.

image::mta-analyze/mta-archetypes.png[archetypes]

Click on the _Summer Framework_ archetype to learn more about how archetypes work. This will open the _Archetype Profile_ side drawer that contains important information about the archetype:

image::mta-analyze/mta-archetypes-summer.png[archetypes]

This archetype has been modeled to cover all traditional Spring applications in the organization, so we can centralize their management. Let's discuss the fields we can find in archetypes:

* Applications that match all the criteria tags will get automatically associated to the archetype. In this case, all applications that have the _Spring_, _Spring MVC_ and _Spring Data_ tags will be associated to the _Summer Framework_ archetype. That is the case of our _Customers_ application.
* Archetype tags are the tags that will be inherited by applications just for the fact of being associated to the current archetype. These are a way to store metadata about applications at scale. In this case we have associated a dedicated tag for the framework (_Summer Framework_) and information about the runtime (_Tomcat_).
* Archetypes often refer to corporate architectures or frameworks that are maintained by some department or team inside the organization. Archetypes also allow to document who are relevant stakeholders associated to them. We can see that the _Summer Framework_ is being maintained by Sanaa Cantu, Lena Bentley and Olumide Themba, alongside the IT Management group.

On the _Applications_ section of the _Archetype Profile_ drawer you can see a link that reads "2 applications". Click on it and you will navigate back to the _Application Inventory_ with preapplied filters to display all applications associated with the _Summer Framework_ archetype. Clicking on the Customers application reveals that it has been associated to the _Summer Framework_ archetype in the _Archetypes_ section from the _Application Profile_.

image::mta-analyze/mta-archetypes-inventory-customers.png[inventory]

Given the association, the application should have inherited the Archetype tags from the Summer Framework archetype. Click on the _Tags_ tab from the _Application Profile_ and filter by Archetype. You should see the tags _Summer Framework_ and _Tomcat_.

image::mta-analyze/mta-archetypes-inventory-customers-tags.png[inventory]

== 2.3. Controls

*Controls* are a collection of entities that are used to surface information about applications in the inventory. They comprise _business services_, _stakeholders_, _stakeholder groups_, _job functions_, _tag types_, and _tags_.

These controls provide useful metadata about the relationships between applications and their business stakeholders, and can be used to optimize a modernization plan across a portfolio.

=== 2.4. Stakeholders

Go to `Controls` on the left menu and you will see existing _Stakeholders_ such as *Borja Cavan* and *Brendon Hayes*.

image::mta-analyze/mta-control-stakeholder.png[stakeholders]

You can also find the existing _Stakeholder groups_ such as *IT Management* and *Retail Management*. You can think of _Stakeholder groups_ as the different teams that support the application landscape in any way inside the organization.

image::mta-analyze/mta-stakeholder-groups.png[stakeholder-groups]

=== 2.5. Business services

The simplest way to classify applications is through business services that represent the different business verticals or divisions that an organization might have.

Go to `Controls` on the left menu and click on _Business services_ tab. You will see existing _business services_ such as *Finance and HR* and *Retail*.

image::mta-analyze/mta-control-business-service.png[business service]


=== 3. Assessing the Summer Framework archetype

The **Assessment module** provides a high level overview of a given application or archetype through the usage of questionnaires. The tool ships with a _Containerization_ questionnaire out of the box, with more curated questionnaires coming up in subsequent releases. The _Containerization_ questionnaire aims to determine the suitability for containerization for each application. It covers all the different areas of the *application landscape*, including the *technology*, *application lifecycle management*, and *operations*. This questionnaire allow the tool to identify and present potential risks that might prevent an application from running in containers or would require extra steps to mitigate the risk.

=== 3.1. Enabling the Containerization questionnaire

All questionnaires are disabled by default on a brand new *MTA* install to allow users to define which questionnaires should be answered by the user to consider an application as _assessed_. **MTA 7** now includes https://access.redhat.com/documentation/en-us/migration_toolkit_for_applications/7.0/html-single/user_interface_guide/index#mta-custom-questionnaire_user-interface-guide[the possibility of authoring custom questionnaires by using a YAML syntax^], but we will stick to the default _Containerization_ questionnaire for this exercise.

Click on the perspective selector on the left menu and select _Administration_. Once the perspective shifts, click on _Assessment Questionnaires_.

image::mta-analyze/mta-questionnaires.png[questionnaires]

This table shows you the list of available questionnaires, with information about number of questions and the different thresholds for all risk levels. The _Legacy Pathfinder_ questionnaire contains the containerization questions we are looking for, so click on the switch from the _Required_ column to enable it.

image::mta-analyze/mta-questionnaires-enabled.png[questionnaires]

This means that, for applications on this MTA instance to be considered as _assessed_, only the _Legacy Pathfinder_ (AKA _Containerization_) questionnaire has to be answered at either application or archetype level.

Click on the perspective selector and select _Migration_ to get back to the _Application Inventory_

image::mta-analyze/mta-intentory-assessed.png[questionnaires]

You will notice that several applications, including our _Customers_ application, now appear to have they assessments completed. This is because some applications were already assessed in this MTA instance.

=== 3.2. Completing the assessment for the Summer Framework archetype

As we were discussing before, one stakeholder team has already assessed the _Summer Framework_ archetype to identify technical problems. However, they couldn't answer the configuration model questions during the first assessment. So they just left the answer as `Unknown` at that time.

Today, you'll run the *second* assessment to choose the proper answer in the `cross-cutting concerns` section for the _Summer Framework_ archetype.

Click on the _Archetypes_ option in the left menu, and then click on the kebab menu (the three vertical dots) for the _Summer Framework_ archetype and select the _Assess_ option.

image::mta-analyze/mta-assessment-summer.png[archetypes]

The system will navigate to a view with a list of the available questionnaires for the _Summer Framework_ archetype. Since the assessment was already done, you will get the options to either _Retake_ the questionnaire or view the previous results.

image::mta-analyze/mta-assessment-summer-options.png[assessment]

Click on _Retake_.

You can think of an questionnaire as the script for having a meaningful conversation. As that conversation will potentially involve multiple stakeholders, it is important to document them in case it is necessary to reach out later to ask for clarifications.

image::mta-analyze/mta-assessment-stakeholders.png[assessment]

You can see that Brendon Hayes, Dante Leblanc and Hanna Miriam were involved in this conversation, as well as the IT Management team. Click on `Next` to begin with the questionnaire.

[NOTE]
====
Review the former answers in the initial assessment for each section such as `Details`, `Dependencies`, and `Observability`. You don't need to change any answers but keep clicking on `Next` button until you get into the `Application cross-cutting concerns` section.
====

image::mta-analyze/mta-assessment-app-details.png[app-details]

Once you arrive to the _Application cross-cutting concerns_ section, choose the following answer for the *How is the application configured?* question. The team finally figured out that applications from the _Summer Framework_ archetype currently use multiple configuration files in different folders/directories, so answer accordingly:

* *Question* - How is the application configured?
* *Answer* - `Multiple configuration files in multiple file system locations`

image::mta-analyze/mta-assessment-app-cross-cutting-concerns.png[app-cross-cutting-concerns]

Click on `Save and review`.

== 3.3. Application Review

You will be presented with the review screen. It allows you to find out which risks were identified during the assessment and decide which migration strategy to follow based those risks.

image::mta-analyze/mta-review.png[review]

In our assessment, MTA found some medium and high risks, we can take a look at them by scrolling down to the list of risks.The _Summer Framework_ archetype uses a static (fixed) discovery mechanism that is not cloud-friendly, which makes sense since it comes from a classic platform and accesses a database through a *static IP*.

As stated before, the archetype also uses a custom configuration library that happens to load configuration from multiple paths on the filesystem. That is definitely an antippattern for cloud deployments, so we will need to find where that library is used in associated applications and replace it with a more cloud friendly approach.

image::mta-analyze/mta-review-risks.png[review-risks]

Now that we know that there will be some changes required in the source code to adapt applications associated to this archetype, we can decide that the strategy will be `Refactor`.

We believe that only the configuration library needs to be replaced, so we would expect the effort required to be `Small`.

* Proposed action: `Refactor`
* Effort estimate: `Small`

Since the _Summer Framework_ archetype is used to build critical applications for the business, we're going to set the criticality to `10` and priority to `9`.

* Business criticality: `10`
* Work priority: `9`

Click on `Submit Review`.

image::mta-analyze/mta-submit-review.png[submit-review]

As discussed before, applications associated to an archetype will inherit some of its properties, **including the assessment and the review**. Click on the _Application Inventory_ option in the left menu, then click on the _Customers_ application. On the _Archetypes_ section from the _Application Profile_ you can see that the associated archetype (_Summer Framework_) appears to be both assessed and reviewed. The _Customers_ application also has the _Completed_ status on its _Assessment_ and _Review_ columns.

image::mta-analyze/mta-complete-review.png[complete-review]

At this point you have completed the 2nd assessment to update the `Application cross-cutting concerns` section. You have also identified a new `high` risk along with the external configuration references and dependencies.

image::mta-analyze/complete-review.png[complete-review]

Now click on the _Review_ tab from the _Application Profile_. As you can see, the values we assigned in the review for the _Summer Framework_ archetype have been inherited by the _Customers_ application.

Go to `Report` on the left menu. There you will be able to access the report details such as _Current landscape_, _Adoption candidate distribution_, _Suggested adoption plan_, and _Identified risks_.

image::mta-analyze/report-review.png[report-review]

*Congratulations!* You have now successfully begun the modernization process by assessing the _Summer Framework_ archetype and you identified issues and risks that will need to be considered in the next step: application analysis and code modification as part of modernization.

Read more about use cases and migration paths at https://developers.redhat.com/products/mta/use-cases[Migration Toolkit for Applications^].

== 4. Analyzing the Customers application

MTA proves an analysis engine capable of static code analysis against both source code and binaries. The _Analysis Module_ provides insights on the dependencies and technology stack of applications, aside from identifying potential issues that might prevent an application from running on a target platform.

As you have realized in the previous *assessment* exercise, you need to analyze the legacy applications in terms of identifying the actual lines of code for the modernization issues as well as estimating time and effort for the modernization project.

The goal of this exercise is to analyze the _Customers_ application by scanning its source code using the _Analysis Module_ in MTA. Then you'll review the analysis report and get started with the actual code modification.

MTA _Analysis_ is used by organizations for:

* Planning and work estimation
* Identifying migration issues and providing solutions
* Detailed reporting

And has several capabilities such as:

* Built-in rules and migration paths
* Rule extensibility and customization
* Ability to analyze source code or application archives

Read more about it in the https://access.redhat.com/documentation/en-us/migration_toolkit_for_applications/7.0/html-single/introduction_to_the_migration_toolkit_for_applications/index#new-mta-features_getting-started-guide[MTA Features]

== 4.1. Analyze Customers Application using MTA

First, you need to configure *Git repositories* to refer to your link:{gitea_console_url}/{gitea_user}/modern-app-dev[Gitea repository^] when you analyze your inventory and applications using MTA.

In *Administration* view, select *Repositories > Git*. `Toggle` the *Consume insecure Git repositories* switch to the right.

image::mta-analyze/mta-admin-git.png[admin git]

[NOTE]
====
You can also log in to the Gitea repository with the following credentials.

* Username - `{gitea_user}`
* Password - `{gitea_password}`
====

Go back to the `Application inventory` page in the *Migration* perspective. Click on pencil (edit) icon for the customers inventory.

Update application with the following source code information.

* Repository type - `Git`
* Source Repository - `{gitea_console_url}/{gitea_user}/modern-app-dev.git`
* Branch - `patch-postgres`
* Root path - `package-legacy`

image::mta-analyze/application-update-git.png[application-update-git]

Select `Save`.

Select the `Analysis` tab. When you click on the `Customers` application, `Analyze` button will be enabled. Then, click on *Analyze*.

image::mta-analyze/application-analysis.png[application-analysis]

=== 2.2. Analysis mode

Select `Source code` in Analysis mode popup.

image::mta-analyze/add-applications.png[Add applications]

Click on `Next`.

=== 2.3. Set targets

You will now be presented with options for transformation targets. Here we will select several targets based on the technologies we are moving to:

Since this is going to be a linux container, it makes sense to do a sanity check to avoid things like Windows filesystem paths and other non-container- or non-Linux-friendly issues. We also going to investigate removing our reliance on a proprietary JDK distribution, so we going to select OpenJDK as a target.

Click on `Containers`, `Linux`, and `OpenJDK` as the targets.

image::mta-analyze/configure-analysis-checked.png[Configure Analysis]

Click on `Next`.

Select `Application and internal dependencies only` for the scope of dependencies.

Click on `Next`.

=== 2.4. Advanced

You will now be presented with options for custom rules.

image::mta-analyze/custom-rules.png[Custom rules]

MTA Analysis uses a custom rule engine for the analysis. It comes with many rules out of the box to support the different migration paths, but it can be extended. Custom rules can be developed with a very simple XML syntax and used as part of the analysis. We've provided some custom rules which will detect the usage of a specific library that we know has been used at Globex in the past and make suggestions for changes to be performed to remove it.

Select `Repository` tab to refer to a custom rule (`corporate-framework-config.windup.xml`) in the *customrules* directory of your Gitea repository.

Key in the following information in the repository page.

* Repository type - `Git`
* Source Repository - `{gitea_console_url}/{gitea_user}/modern-app-dev.git`
* Branch - `patch-postgres`
* Root path - `customrules`
* Associated credentials - `None`

[NOTE]
====
In case you don't see `None` in the `Associated credentials`, please leave it since the field is not mandatory.
====

image::mta-analyze/add-repository-customrules.png[add-repository-customrules]

Click on `Next`.

Next, you will be presented with options to fine tune the analysis. For now we will stick with the default options.

image::mta-analyze/fine-tune.png[Fine tuning]

Click on `Next`.

Lastly, we are presented with a summary of the configuration for our analysis.

image::mta-analyze/finish-project.png[Finish project]

Click on `Run`.

The analysis begins, and once it is finished you will be able to access the reports. Stay on this view until the analysis is finished.

Once it finishes, select *Customers* application. Then click on `Report` in the *Reports* tab on the right.

[NOTE]
====
The analysis may take a few minutes as it must pull container images for Windup before executing the analysis.
====

image::mta-analyze/active-analysis.png[Active analysis]

== 2.5. Understanding the report

The Dashboard gives an overview of the entire application migration effort. It summarizes:

* The incidents and story points by category
* The incidents and story points by level of effort of the suggested changes
* The incidents by package

[NOTE]
Story points are an abstract metric commonly used in Agile software development to estimate the relative level of effort needed to implement a feature or change. Migration Toolkit for Application uses story points to express the level of effort needed to migrate particular application constructs, and the application as a whole. The level of effort will vary greatly depending on the size and complexity of the application(s) to migrate.

Once the report is finished, click on the link to access the report. Click on `customers-tomcat.war` application.

image::mta-analyze/report-view.png[View report]

The reports provide all kinds of information about the application, like the technologies it uses, dependencies, but most importantly issues that need to get fixed.

image::mta-analyze/report-dashboard.png[report dashboard]

Click on the `Issues` tab.

This view shows us the list of issues that could prevent an application to successfully run on the target runtime. We can see that the application has a few mandatory issues that need to be addressed.

Click on `Hard coded IP address`.

By choosing the issue we can see where it was detected and view a hint on how to solve it.  It looks like the config files are pointing to some static IPs. That's not good in a cloud / container environment!

image::mta-analyze/report-hint.png[report hint]

Click on `File system issue`.

It looks like a problem has been detected on some class coming from the config library. We are analyzing the binary, so the dependencies have been analyzed as well.

image::mta-analyze/report-hint-fs.png[report hint file system]

Click on `Legacy configuration issue`.

It looks like the custom rule got triggered and found some issues with the source code.  This rule detects the use of a custom configuration library and gives some hints about what needs to be done to fix it.

image::mta-analyze/report-hint-custom.png[report hint custom rule]

Click on the `io.konveyor.demo.ordermanagement.config.PersistenceConfig` file.

image::mta-analyze/report-code.png[report code]

You can now see exactly where the issue is located in the source code.

== Summary

You have now successfully analyzed the legacy application to learn what migration issues you have. You'll refactor the application to fix the issues in the next module. Then, you'll deploy the modernized application to Red Hat OpenShift. Let's go!
